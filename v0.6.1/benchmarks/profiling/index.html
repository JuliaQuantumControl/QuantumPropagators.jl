<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Profiling Howto · QuantumPropagators.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://juliaquantumcontrol.github.io/QuantumPropagators.jl/benchmarks/profiling/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/citations.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">QuantumPropagators.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../overview/">Overview</a></li><li><a class="tocitem" href="../../generators/">Dynamical Generators</a></li><li><a class="tocitem" href="../../methods/">Propagation Methods</a></li><li><a class="tocitem" href="../../storage/">Expectation Values</a></li><li><a class="tocitem" href="../../examples/">Examples</a></li><li><a class="tocitem" href="../../howto/">Howtos</a></li><li><a class="tocitem" href="../">Benchmarks</a><ul><li class="is-active"><a class="tocitem" href>Profiling Howto</a><ul class="internal"><li><a class="tocitem" href="#BenchmarkTools"><span>BenchmarkTools</span></a></li><li><a class="tocitem" href="#TimerOutputs"><span>TimerOutputs</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../api/quantumpropagators/">API</a></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a href="../">Benchmarks</a></li><li class="is-active"><a href>Profiling Howto</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Profiling Howto</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaQuantumControl/QuantumPropagators.jl/blob/master/docs/src/benchmarks/profiling.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Profiling-Howto"><a class="docs-heading-anchor" href="#Profiling-Howto">Profiling Howto</a><a id="Profiling-Howto-1"></a><a class="docs-heading-anchor-permalink" href="#Profiling-Howto" title="Permalink"></a></h1><p>To choose an appropriate propagation method and parameters for a given problem, it is essential to benchmark and profile the propagation.</p><p>Consider the following simple example:</p><pre><code class="language-julia hljs">using QuantumControlTestUtils.RandomObjects: random_dynamic_generator, random_state_vector

tlist = collect(range(0, step=1.0, length=101));
N = 200;  # size of Hilbert space
H = random_dynamic_generator(N, tlist);
Ψ₀ = random_state_vector(N);</code></pre><h2 id="BenchmarkTools"><a class="docs-heading-anchor" href="#BenchmarkTools">BenchmarkTools</a><a id="BenchmarkTools-1"></a><a class="docs-heading-anchor-permalink" href="#BenchmarkTools" title="Permalink"></a></h2><p>The first line of defense is the use of <a href="https://juliaci.github.io/BenchmarkTools.jl/stable/"><code>BenchmarkTools</code></a>. The <code>@benchmark</code> macro allows to generate statistics on how long a call to <a href="../../api/quantumpropagators/#QuantumPropagators.propagate"><code>propagate</code></a> takes.</p><h3 id="Chebychev-propagation"><a class="docs-heading-anchor" href="#Chebychev-propagation">Chebychev propagation</a><a id="Chebychev-propagation-1"></a><a class="docs-heading-anchor-permalink" href="#Chebychev-propagation" title="Permalink"></a></h3><p>For example, we can time the propagation with the Chebychev method:</p><pre><code class="language-julia hljs">using BenchmarkTools
using QuantumPropagators

@benchmark propagate($Ψ₀, $H, $tlist; method=:cheby) samples=10</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 10 samples with 1 evaluation.
 Range (min … max):  25.246 ms …  28.375 ms  ┊ GC (min … max): 0.00% … 0.00%
 Time  (median):     26.626 ms               ┊ GC (median):    0.00%
 Time  (mean ± σ):   26.726 ms ± 995.028 μs  ┊ GC (mean ± σ):  0.00% ± 0.00%

  ▁ ▁                ▁     ▁█ ▁                 ▁ ▁          ▁  
  █▁█▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁█▁▁▁▁▁██▁█▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁█▁█▁▁▁▁▁▁▁▁▁▁█ ▁
  25.2 ms         Histogram: frequency by time         28.4 ms &lt;

 Memory estimate: 1.49 MiB, allocs estimate: 3874.</code></pre><h3 id="Newton-propagation"><a class="docs-heading-anchor" href="#Newton-propagation">Newton propagation</a><a id="Newton-propagation-1"></a><a class="docs-heading-anchor-permalink" href="#Newton-propagation" title="Permalink"></a></h3><p>Or, the same propagation with the Newton method:</p><pre><code class="language-julia hljs">@benchmark propagate($Ψ₀, $H, $tlist; method=:newton) samples=10</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 10 samples with 1 evaluation.
 Range (min … max):  112.425 ms … 122.393 ms  ┊ GC (min … max): 0.00% … 2.65%
 Time  (median):     115.805 ms               ┊ GC (median):    0.00%
 Time  (mean ± σ):   116.590 ms ±   3.149 ms  ┊ GC (mean ± σ):  1.12% ± 1.43%

  ▁       █       ▁▁     ▁      ▁           ▁  ▁              ▁  
  █▁▁▁▁▁▁▁█▁▁▁▁▁▁▁██▁▁▁▁▁█▁▁▁▁▁▁█▁▁▁▁▁▁▁▁▁▁▁█▁▁█▁▁▁▁▁▁▁▁▁▁▁▁▁▁█ ▁
  112 ms           Histogram: frequency by time          122 ms &lt;

 Memory estimate: 17.98 MiB, allocs estimate: 56702.</code></pre><p>The result in this case illustrates the significant advantage of the Chebychev method for systems of moderate to small size and unitary dynamics.</p><p>When using custom data structures for the dynamical generators or states, <code>@benchmark</code> should also be used to optimize lower-level operations as much as possible, e.g. the application of the Hamiltonian to the state.</p><h2 id="TimerOutputs"><a class="docs-heading-anchor" href="#TimerOutputs">TimerOutputs</a><a id="TimerOutputs-1"></a><a class="docs-heading-anchor-permalink" href="#TimerOutputs" title="Permalink"></a></h2><p>A lot more insight into the internals of a <a href="../../api/quantumpropagators/#QuantumPropagators.propagate"><code>propagate</code></a> call can be obtained by collecting timing data. This functionality is integrated in <code>QuantumPropagators</code> and uses the <a href="https://github.com/KristofferC/TimerOutputs.jl#readme"><code>TimerOutputs</code></a> package internally.</p><h3 id="Enabling-the-collection-of-timing-data"><a class="docs-heading-anchor" href="#Enabling-the-collection-of-timing-data">Enabling the collection of timing data</a><a id="Enabling-the-collection-of-timing-data-1"></a><a class="docs-heading-anchor-permalink" href="#Enabling-the-collection-of-timing-data" title="Permalink"></a></h3><p>To enable collecting internal timing data, call <a href="../../api/quantumpropagators/#QuantumPropagators.enable_timings"><code>QuantumPropagators.enable_timings</code></a>:</p><pre><code class="language-julia hljs">QuantumPropagators.enable_timings()</code></pre><p>The status of the data collection can be verified with <a href="../../api/quantumpropagators/#QuantumPropagators.timings_enabled"><code>QuantumPropagators.timings_enabled</code></a>.</p><h3 id="Chebychev-propagation-2"><a class="docs-heading-anchor" href="#Chebychev-propagation-2">Chebychev propagation</a><a class="docs-heading-anchor-permalink" href="#Chebychev-propagation-2" title="Permalink"></a></h3><p>Since the call to <a href="../../api/quantumpropagators/#QuantumPropagators.enable_timings"><code>QuantumPropagators.enable_timings</code></a> invalidates existing compiled code, and to avoid the compilation overhead showing up in the timing data, we call <a href="../../api/quantumpropagators/#QuantumPropagators.propagate"><code>propagate</code></a> once to ensure compilation:</p><pre><code class="language-julia hljs">propagate(Ψ₀, H, tlist; method=:cheby);</code></pre><p>In any subsequent propagation, we could access the timing data in a <code>callback</code> to <a href="../../api/quantumpropagators/#QuantumPropagators.propagate"><code>propagate</code></a>:</p><pre><code class="language-julia hljs">function show_timing_data(propagator, args...)
    if propagator.t == tlist[end]
        show(propagator.wrk.timing_data, compact=true)
    end
end

propagate(Ψ₀, H, tlist; method=:cheby, callback=show_timing_data);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"> ───────────────────────────────────────────────────────────────────
                                         Time          Allocations
                                   ───────────────   ───────────────
          Total measured:               321ms            20.3MiB

 Section                   ncalls     time    %tot     alloc    %tot
 ───────────────────────────────────────────────────────────────────
 prop_step!                   100   21.5ms  100.0%    134KiB  100.0%
   matrix-vector product    1.20k   20.0ms   93.1%     0.00B    0.0%
 ───────────────────────────────────────────────────────────────────</code></pre><p>See the <a href="https://github.com/KristofferC/TimerOutputs.jl#settings-for-printing"><code>TimerOutputs</code> documentation</a> for details on how to print the <code>timing_data</code>.</p><p>Alternatively, without a <code>callback</code>:</p><pre><code class="language-julia hljs">propagator = init_prop(Ψ₀, H, tlist; method=:cheby)
for step ∈ 1:(length(tlist)-1)
    prop_step!(propagator)
end
show(propagator.wrk.timing_data, compact=true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"> ───────────────────────────────────────────────────────────────────
                                         Time          Allocations
                                   ───────────────   ───────────────
          Total measured:              59.3ms             522KiB

 Section                   ncalls     time    %tot     alloc    %tot
 ───────────────────────────────────────────────────────────────────
 prop_step!                   100   22.4ms  100.0%    134KiB  100.0%
   matrix-vector product    1.20k   20.9ms   93.5%     0.00B    0.0%
 ───────────────────────────────────────────────────────────────────</code></pre><p>The reported runtimes here are less important than the number of function calls and the runtime percentages. In this case, the timing data shows that the propagation is dominated by the matrix-vector products (applying the Hamiltonian to the state), as it should. The percentage would go to 100% for larger Hilbert spaces.</p><h3 id="Newton-propagation-2"><a class="docs-heading-anchor" href="#Newton-propagation-2">Newton propagation</a><a class="docs-heading-anchor-permalink" href="#Newton-propagation-2" title="Permalink"></a></h3><p>For the Newton method:</p><pre><code class="language-julia hljs">propagate(Ψ₀, H, tlist; method=:newton);   # recompilation
propagate(Ψ₀, H, tlist; method=:newton, callback=show_timing_data);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"> ───────────────────────────────────────────────────────────────────────────
                                                 Time          Allocations
                                           ───────────────   ───────────────
              Total measured:                   120ms            17.7MiB

 Section                           ncalls     time    %tot     alloc    %tot
 ───────────────────────────────────────────────────────────────────────────
 prop_step!                           100    111ms  100.0%   17.5MiB  100.0%
   diagonalize_hessenberg_matrix      200   38.0ms   34.3%   9.76MiB   55.9%
   arnoldi!                           200   37.1ms   33.5%   16.4KiB    0.1%
     matrix-vector product          2.00k   34.0ms   30.7%     0.00B    0.0%
   get Leja points                    200   29.5ms   26.6%   6.25KiB    0.0%
   evaluate polynomial                200   2.62ms    2.4%   6.41MiB   36.7%
   get Newton coeffs                  200    342μs    0.3%   3.12KiB    0.0%
 ───────────────────────────────────────────────────────────────────────────</code></pre><p>We see here that the Newton propagation requires more matrix-vector products (2000 compared to 1200 for Chebychev), partly because the Newton propagator is &quot;chunked&quot; to <code>m_max</code> applications in each &quot;restart&quot; (10 by default, with 2 restarts required to reach machine precision in this case). Moreover, there is significant overhead beyond just matrix-vector multiplication, which will disappear only for significantly larger Hilbert spaces.</p><h3 id="Disabling-the-collection-of-timing-data"><a class="docs-heading-anchor" href="#Disabling-the-collection-of-timing-data">Disabling the collection of timing data</a><a id="Disabling-the-collection-of-timing-data-1"></a><a class="docs-heading-anchor-permalink" href="#Disabling-the-collection-of-timing-data" title="Permalink"></a></h3><p>There there is a <a href="https://github.com/KristofferC/TimerOutputs.jl#overhead">small overhead</a> associated with collecting the timing data, it should not be enabled &quot;in production&quot;. To <a href="../../api/quantumpropagators/#QuantumPropagators.disable_timings"><code>QuantumPropagators.disable_timings</code></a> function undoes the previous <a href="../../api/quantumpropagators/#QuantumPropagators.enable_timings"><code>QuantumPropagators.enable_timings</code></a>:</p><pre><code class="language-julia hljs">QuantumPropagators.disable_timings()</code></pre><p>This again will trigger recompilation of any method that was collecting timing data, removing the associated overhead.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Benchmarks</a><a class="docs-footer-nextpage" href="../../api/quantumpropagators/">API »</a><div class="flexbox-break"></div><p class="footer-message"><a href="https://github.com/JuliaQuantumControl/QuantumPropagators.jl">QuantumPropagators.jl</a> v0.6.1 docs powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 4 October 2023 20:38">Wednesday 4 October 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
